<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Barcelona 2026 | Guía PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Barcelona 2026">
    <meta name="description" content="Guía personalizada para la escala en Barcelona 2026">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgTO8Unw1Rh2yVa2JGn5EqDKRRzmCWqYcp-Cfs83S-XE510ErtaNkBMj73Ucv0qXmgv_7NJRKH6olpiE1Bf4uBBln1jiHfaAKuk_RgrVaISXO1K6HJwZ30r8SqkyV1f7eCCLVlb1UXAry6yfi7k2rNhmJzjYjrE3jBwxFN5462NoLZRPU67Z792PDZUr2o/s320/Gemini_Generated_Image_gn7f5hgn7f5hgn7f.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        genova: { 
                          50: '#eff6ff', 
                          100: '#dbeafe', 
                          200: '#bfdbfe', 
                          300: '#93c5fd', 
                          400: '#60a5fa', 
                          500: '#3b82f6', 
                          600: '#2563eb', 
                          700: '#1d4ed8', 
                          800: '#1e40af', 
                          900: '#1e3a8a' 
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overscroll-behavior-y: none; background-color: #f8fafc; }
        body { font-family: 'Roboto Condensed', sans-serif; -webkit-tap-highlight-color: transparent; }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-h-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-h-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-h-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .leaflet-bottom { bottom: 85px !important; }
        
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e3a8a; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s ease-out;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Estilos para el popup personalizado */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 4px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .leaflet-popup-tip { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react",
    "recharts": "https://esm.sh/recharts@2.13.0?external=react",
    "leaflet": "https://esm.sh/leaflet@1.9.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="initial-loader">
        <div style="text-align: center; color: white;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px;"></div>
            <p style="font-weight: bold; letter-spacing: 1.5px; font-size: 11px; text-transform: uppercase; opacity: 0.8;">Iniciando Guía Barcelona</p>
        </div>
    </div>

    <div id="root"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, 
            Headphones, X, Play, Square, Navigation, CheckCircle2, 
            Circle, MapPin, AlertTriangle, Clock, ExternalLink, AlertCircle,
            Volume2, Languages, PhoneCall, Thermometer, ArrowRight,
            Sun, Cloud, CloudRain, CloudLightning, Calendar, Footprints, Activity as ActivityIcon, Send,
            Wind, CalendarDays, TrendingDown, Info, Ticket, Landmark, Timer
        } from 'lucide-react';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

        // --- DATA & CONSTANTS ---
        
        const SHIP_DEPARTURE_TIME = "18:00";
        const SHIP_ONBOARD_TIME = "17:30";
        const DATE_OF_VISIT = "2026-04-12";

        const COORDS = {
            BARCELONA_PORT: { lat: 41.362895, lng: 2.181948 },
            COLON: { lat: 41.375798, lng: 2.177774 },
            SAGRADA_FAMILIA: { lat: 41.40406, lng: 2.173935 },
            LA_PEDRERA: { lat: 41.395174, lng: 2.161777 },
            CASA_BATLLO: { lat: 41.391714, lng: 2.165002 },
            BOQUERIA: { lat: 41.381939, lng: 2.172071 }
        };

        const GPX_WAYPOINTS = [
            { name: "EDIFICIO WORLD TRADE CENTER", lat: 41.371587, lng: 2.181265 },
            { name: "CRUISE BUS (AZUL)", lat: 41.37182, lng: 2.179492 },
            { name: "METRO DRASSANES", lat: 41.376913, lng: 2.1759 },
            { name: "MONUMENTO A COLÓN", lat: 41.375798, lng: 2.177774 },
            { name: "METRO PASEO DE GRACIA", lat: 41.391519, lng: 2.165324 },
            { name: "LA PEDRERA - RUTA DEL MODERNISMO", lat: 41.395174, lng: 2.161777 },
            { name: "Casa Batlló", lat: 41.391714, lng: 2.165002 },
            { name: "METRO SAGRADA FAMILIA", lat: 41.40406, lng: 2.173935 },
            { name: "METRO JAUME I", lat: 41.383988, lng: 2.178874 },
            { name: "CATEDRAL DEL MAR", lat: 41.383497, lng: 2.181772 },
            { name: "TERMINAL DE CRUCEROS", lat: 41.362895, lng: 2.181948 },
            { name: "METRO DIAGONAL", lat: 41.395839, lng: 2.159938 },
            { name: "LA BOQUERIA - CERRADA EN DOMINGO", lat: 41.381939, lng: 2.172071 },
            { name: "CATEDRAL DE BARCELONA", lat: 41.382326, lng: 2.173742 },
            { name: "METRO LICEU", lat: 41.381387, lng: 2.173061 }
        ];

        const BARCELONA_TRACK = [
            [41.372324, 2.178648], [41.372887, 2.17745], [41.372917, 2.177385], [41.372972, 2.177428], [41.373037, 2.177476], [41.373068, 2.177503], [41.37313, 2.177367], [41.373184, 2.177454], [41.373252, 2.177521], [41.373263, 2.177498], [41.373271, 2.177471], [41.373342, 2.177504], [41.373413, 2.177503], [41.373499, 2.177467], [41.373579, 2.177382], [41.373605, 2.177352], [41.373643, 2.177283], [41.373674, 2.177209], [41.373695, 2.177127], [41.373693, 2.177067], [41.373759, 2.177082], [41.373804, 2.177089], [41.373851, 2.177097], [41.373873, 2.177097], [41.373908, 2.177097], [41.373941, 2.177095], [41.373977, 2.177095], [41.374094, 2.177062], [41.374228, 2.177], [41.374383, 2.176848], [41.374469, 2.1769], [41.37453, 2.17695], [41.375254, 2.177528], [41.375264, 2.177507], [41.37529, 2.177448], [41.375317, 2.177388], [41.375326, 2.177367], [41.375331, 2.177356], [41.37537, 2.177393], [41.375395, 2.177412], [41.375444, 2.177454], [41.375491, 2.177492], [41.375516, 2.177509], [41.375552, 2.177535], [41.375564, 2.177537], [41.37557, 2.17753], [41.375591, 2.177512], [41.375627, 2.177482], [41.375663, 2.177467], [41.375685, 2.17746], [41.375711, 2.177458], [41.375761, 2.17746], [41.375775, 2.177447], [41.37584, 2.177405], [41.375934, 2.177343], [41.375944, 2.177297], [41.376069, 2.177197], [41.376092, 2.177229], [41.376564, 2.176819], [41.37656, 2.176808], [41.376553, 2.176794], [41.37654, 2.176765], [41.376524, 2.176732], [41.376817, 2.176473], [41.376994, 2.176314], [41.377026, 2.17629], [41.377034, 2.176255], [41.377482, 2.176213], [41.377931, 2.176172], [41.378379, 2.176131], [41.378828, 2.17609], [41.379276, 2.176048], [41.379725, 2.176007], [41.380174, 2.175966], [41.380622, 2.175925], [41.381071, 2.175884], [41.381519, 2.175842], [41.381968, 2.175801], [41.382417, 2.17576], [41.382865, 2.175719], [41.383314, 2.175678], [41.383762, 2.175636], [41.384211, 2.175595], [41.384660, 2.175554], [41.385108, 2.175513], [41.385557, 2.175471], [41.386005, 2.17543], [41.386454, 2.175389], [41.386903, 2.175348], [41.387351, 2.175307], [41.3878, 2.175265], [41.388248, 2.175224], [41.388697, 2.175183], [41.389146, 2.175142], [41.389594, 2.175101], [41.390043, 2.175059], [41.390491, 2.175018], [41.39094, 2.174977], [41.391389, 2.174936], [41.391837, 2.174895], [41.392286, 2.174853], [41.392734, 2.174812], [41.393183, 2.174771], [41.393632, 2.17473], [41.39408, 2.174688], [41.394529, 2.174647], [41.394977, 2.174606], [41.395426, 2.174565], [41.395875, 2.174524], [41.396323, 2.174482], [41.396772, 2.174441], [41.39722, 2.1744], [41.397669, 2.174359], [41.398118, 2.174318], [41.398566, 2.174276], [41.399015, 2.174235], [41.399463, 2.174194], [41.399912, 2.174153], [41.40036, 2.174111], [41.400809, 2.17407], [41.401258, 2.174029], [41.401706, 2.173988], [41.402155, 2.173947], [41.402603, 2.173905], [41.403052, 2.173864], [41.403501, 2.173823], [41.403949, 2.173782], [41.404008, 2.173776], [41.404015, 2.173768], [41.403713, 2.173356], [41.403509, 2.173161], [41.402018, 2.17117], [41.400347, 2.169002], [41.398556, 2.16655], [41.396928, 2.16434], [41.395013, 2.16185], [41.392226, 2.164582], [41.387271, 2.168489], [41.382581, 2.172046], [41.381229, 2.173064], [41.38138, 2.173464], [41.38159, 2.173389], [41.382389, 2.173767], [41.383312, 2.177995], [41.383533, 2.18149], [41.383122, 2.181924], [41.381552, 2.182183], [41.380212, 2.182668], [41.379417, 2.181942], [41.376526, 2.179776], [41.37542, 2.178649], [41.372538, 2.178956]
        ];

        const INITIAL_ITINERARY = [
        {
            "id": "1",
            "title": "Llegada al Puerto de Barcelona",
            "startTime": "08:00",
            "endTime": "08:00",
            "locationName": "Terminal de Cruceros Barcelona",
            "coords": { "lat": 41.362895, "lng": 2.181948 },
            "description": "Llegada del barco a puerto. Preparación para el desembarque.",
            "keyDetails": "Tener a mano la tarjeta de embarque.",
            "priceEUR": 0,
            "type": "logistics",
            "completed": false,
            "notes": "CRITICAL"
        },
        {
            "id": "2",
            "title": "Desembarco y Shuttle (Cruise Bus)",
            "startTime": "09:45",
            "endTime": "10:15",
            "locationName": "Terminal de Cruceros",
            "endLocationName": "Monumento a Colón",
            "coords": { "lat": 41.362895, "lng": 2.181948 },
            "endCoords": { "lat": 41.375798, "lng": 2.177774 },
            "description": "Traslado en autobús lanzadera (Cruise Bus azul) hasta Colón.",
            "keyDetails": "Comprar ticket en el bus (aprox 4.50€).",
            "priceEUR": 4.5,
            "type": "transport",
            "completed": false,
            "contingencyNote": "Si hay mucha cola, valorar taxi compartido."
        },
        {
            "id": "3",
            "title": "Metro a Sagrada Familia",
            "startTime": "10:40",
            "endTime": "11:10",
            "locationName": "Metro Drassanes (L3)",
            "endLocationName": "Metro Sagrada Familia",
            "coords": { "lat": 41.376913, "lng": 2.1759 },
            "endCoords": { "lat": 41.40406, "lng": 2.173935 },
            "description": "Caminar a Drassanes (L3 Verde), transbordo en Paral-lel a L2 (Lila).",
            "keyDetails": "Usar tarjeta 'T-Familiar'. Bajarse en 'Sagrada Familia'.",
            "priceEUR": 2.9,
            "type": "transport",
            "completed": false,
            "googleMapsUrl": "https://maps.app.goo.gl/pcdyeNVY2btj4WPS8"
        },
        {
            "id": "4",
            "title": "Sagrada Familia",
            "startTime": "11:20",
            "endTime": "12:20",
            "locationName": "Basílica de la Sagrada Família",
            "coords": { "lat": 41.40406, "lng": 2.173935 },
            "description": "Visita exterior de la Fachada de la Pasión y Natividad. La gran obra maestra inacabada de Antoni Gaudí.",
            "keyDetails": "Fotos imprescindibles desde la Plaza de Gaudí.",
            "priceEUR": 0,
            "type": "sightseeing",
            "completed": false,
            "contingencyNote": "Entrada estricta con hora reservada. Si llueve, tomar Metro.",
            "audioGuideText": "Estás ante el monumento más visitado de España. La Sagrada Familia es una biblia en piedra. Gaudí dedicó sus últimos 12 años exclusivamente a esta basílica. Observa la Fachada del Nacimiento: es una explosión de vida y naturaleza. Al otro lado, la Fachada de la Pasión es austera y angular, representando el sufrimiento. Cuando se termine, su torre central será el punto más alto de Barcelona, pero siempre un metro por debajo de la montaña de Montjuic, porque Gaudí decía que la obra del hombre no debe superar a la de Dios."
        },
        {
            "id": "5",
            "title": "Ruta Modernista hasta La Pedrera",
            "startTime": "12:20",
            "endTime": "12:50",
            "locationName": "Sagrada Familia",
            "endLocationName": "La Pedrera (Casa Milà)",
            "coords": { "lat": 41.40406, "lng": 2.173935 },
            "endCoords": { "lat": 41.395174, "lng": 2.161777 },
            "description": "Caminata por el Eixample, el corazón del diseño burgués de principios del siglo XX.",
            "keyDetails": "Distancia 1.4km. Caminata agradable plana.",
            "priceEUR": 0,
            "type": "walk",
            "completed": false,
            "audioGuideText": "Estamos recorriendo el Eixample, un barrio diseñado con una cuadrícula perfecta por Ildefons Cerdà. Al final de este paseo nos espera La Pedrera. Su nombre oficial es Casa Milà, pero los barceloneses la apodaron 'la cantera' por su aspecto rudo de piedra ondulada. Gaudí se inspiró en las formas de la naturaleza, por eso no verás ni una sola línea recta en su fachada. Sus balcones de hierro forjado parecen algas marinas y su azotea es famosa por las chimeneas que parecen guerreros petrificados."
        },
        {
            "id": "6",
            "title": "Recorrido hasta Casa Batlló",
            "startTime": "12:50",
            "endTime": "13:00",
            "locationName": "Passeig de Gràcia",
            "coords": { "lat": 41.395174, "lng": 2.161777 },
            "endCoords": { "lat": 41.391714, "lng": 2.165002 },
            "description": "Admiración de la joya de la 'Manzana de la Discordia'. La fachada más colorida de la ciudad.",
            "keyDetails": "Admirar Casa Batlló y Casa Amatller (justo al lado).",
            "priceEUR": 0,
            "type": "walk",
            "completed": false,
            "audioGuideText": "Mira la fachada de la Casa Batlló. Es una de las obras más creativas de Gaudí. Muchos ven en ella la leyenda de Sant Jordi: el tejado escamoso es el lomo del dragón, y la torre con la cruz es la lanza del caballero. Las columnas de las plantas bajas parecen huesos, por eso también se la conoce como la 'Casa de los Huesos'. Los balcones tienen forma de antifaces, y todo el conjunto brilla con fragmentos de cerámica de colores que imitan la superficie de un mar en calma."
        },
        {
            "id": "7",
            "title": "Metro Paseo de Gràcia a Liceu",
            "startTime": "13:00",
            "endTime": "13:20",
            "locationName": "Metro Paseo de Gràcia",
            "endLocationName": "Metro Liceu",
            "coords": { "lat": 41.391519, "lng": 2.165324 },
            "endCoords": { "lat": 41.381387, "lng": 2.173061 },
            "description": "L3 (Línea Verde) directa hasta el centro de Las Ramblas.",
            "keyDetails": "Entrada de metro justo delante de Casa Batlló.",
            "priceEUR": 2.9,
            "type": "transport",
            "completed": false,
            "googleMapsUrl": "https://maps.app.goo.gl/pcdyeNVY2btj4WPS8"
        },
        {
            "id": "8",
            "title": "Paseo de La Rambla al Barrio Gótico",
            "startTime": "13:30",
            "endTime": "14:00",
            "locationName": "Mercado de la Boquería",
            "coords": { "lat": 41.381939, "lng": 2.172071 },
            "description": "Recorrido por la vía más famosa de Barcelona hacia el laberinto medieval.",
            "keyDetails": "Evitar terrazas y sitios para comer que son muy caros en esta zona",
            "priceEUR": 0,
            "type": "walk",
            "completed": false,
            "audioGuideText": "Caminas por Las Ramblas, un antiguo torrente de agua que hoy es la arteria de la ciudad. A tu derecha está el Mercado de la Boquería; aunque hoy domingo esté cerrado, su estructura metálica de mil novecientos catorce sigue siendo impresionante. Al adentrarnos en las calles laterales, pasamos del ruido de la rambla al silencio del Barrio Gótico. Aquí se encontraba la antigua ciudad romana de Barcino y todavía hoy podemos ver restos de sus murallas y el trazado de sus plazas señoriales."
        },
        {
            "id": "9",
            "title": "Barrio Gótico y Catedral del Mar",
            "startTime": "14:00",
            "endTime": "14:30",
            "locationName": "Basílica de Santa Maria del Mar",
            "coords": { "lat": 41.383497, "lng": 2.181772 },
            "description": "Paseo histórico por las callejuelas del centro. El corazón de la Barcelona medieval.",
            "keyDetails": "La Catedral del Mar.",
            "priceEUR": 0,
            "type": "walk",
            "completed": false,
            "audioGuideText": "Llegamos a Santa Maria del Mar, conocida como la Catedral del Mar. Es el ejemplo más perfecto del gótico catalán. A diferencia del gótico francés, aquí prima la horizontalidad y la sobriedad. Fue construida en un tiempo récord de cincuenta y cuatro años gracias al esfuerzo de los 'bastaixos', los estibadores del puerto, que cargaban las piedras una a una desde la montaña de Montjuic. Su interior es un espacio diáfano y elegante donde la luz juega un papel fundamental a través de sus rosetones."
        },
        {
            "id": "10",
            "title": "Regreso a Shuttle ",
            "startTime": "14:30",
            "endTime": "15:00",
            "locationName": "Catedral del Mar",
            "endLocationName": "Monumento a Colón",
            "coords": { "lat": 41.383497, "lng": 2.181772 },
            "endCoords": { "lat": 41.375798, "lng": 2.177774 },
            "description": "Paseo por el Paseo Marítimo para tomar el shuttle. Disfrutando de la brisa marina.",
            "keyDetails": "Paseo de unos 20-25 minutos por el frente marítimo.",
            "priceEUR": 0,
            "type": "walk",
            "completed": false,
            "audioGuideText": "Estamos regresando hacia el puerto por el frente marítimo. A tu izquierda queda el Port Vell, el puerto antiguo, que fue renovado totalmente para las Olimpiadas de mil novecientos noventa y dos. Al fondo verás la columna de Colón, con el almirante señalando hacia el mar. Es el momento ideal para tomar las últimas fotos del skyline de Barcelona y prepararnos para el regreso al barco. Recuerda verificar que tienes contigo todos los tickets y la tarjeta del crucero."
        },
        {
            "id": "11",
            "title": "Shuttle Bus al Barco / COMEMOS EN EL BARCO",
            "startTime": "15:00",
            "endTime": "15:30",
            "locationName": "Monumento a Colón",
            "endLocationName": "Terminal de Cruceros",
            "coords": { "lat": 41.375798, "lng": 2.177774 },
            "endCoords": { "lat": 41.362895, "lng": 2.181948 },
            "description": "Autobús de vuelta a la terminal. Suele haber cola.",
            "keyDetails": "Tener el ticket de vuelta preparado.",
            "priceEUR": 0,
            "type": "transport",
            "completed": false
        },
        {
            "id": "12",
            "title": "TODOS A BORDO",
            "startTime": "17:30",
            "endTime": "17:30",
            "locationName": "Terminal de Cruceros",
            "coords": { "lat": 41.362895, "lng": 2.181948 },
            "description": "Control de seguridad y embarque.",
            "keyDetails": "Límite absoluto. ¡No llegues tarde!",
            "priceEUR": 0,
            "type": "logistics",
            "completed": false,
            "notes": "CRITICAL"
        },
        {
            "id": "13",
            "title": "Salida del Puerto",
            "startTime": "18:00",
            "endTime": "18:00",
            "locationName": "Puerto de Barcelona",
            "coords": { "lat": 41.362895, "lng": 2.181948 },
            "description": "Zarpe oficial del barco.",
            "keyDetails": "Fin de la escala en Barcelona.",
            "priceEUR": 0,
            "type": "logistics",
            "completed": false
        }
        ];

        const PRONUNCIATIONS = [
            { word: 'Bon dia', phonetic: "Bon dee-ah", simplified: 'Bon día', meaning: 'Buenos días' },
            { word: 'Gràcies', phonetic: "Grah-sy-es", simplified: 'Gracias', meaning: 'Gracias' },
            { word: 'On es el bany?', phonetic: "On es el bah-ny", simplified: 'Dové el baño', meaning: '¿Dónde está el baño?' },
            { word: 'El compte, si us plau', phonetic: "El kon-te sees plaw", simplified: 'La cuenta', meaning: 'La cuenta, por favor' },
            { word: 'D\'acord', phonetic: "Dah-kord", simplified: 'De acuerdo', meaning: 'De acuerdo' }
        ];

        // --- UTILS ---
        
        const formatMinutes = (mins) => {
          const h = Math.floor(mins / 60);
          const m = mins % 60;
          if (h > 0 && m > 0) return `${h}h ${m}min`;
          if (h > 0) return `${h}h`;
          return `${m}min`;
        };

        const calculateDuration = (startStr, endStr) => {
          const [startH, startM] = startStr.split(':').map(Number);
          const [endH, endM] = endStr.split(':').map(Number);
          let diffMins = (endH * 60 + endM) - (startH * 60 + startM);
          if (diffMins < 0) diffMins += 24 * 60; 
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
          if (hours > 0) return `${hours}h`;
          return `${minutes} min`;
        };

        const calculateTimeProgress = (startTime, endTime) => {
          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          const [startH, startM] = startTime.split(':').map(Number);
          const startMinutes = startH * 60 + startM;
          const [endH, endM] = endTime.split(':').map(Number);
          const endMinutes = endH * 60 + endM;
          if (currentMinutes < startMinutes) return 0;
          if (currentMinutes >= endMinutes) return 100;
          return Math.min(100, Math.max(0, ((currentMinutes - startMinutes) / (endMinutes - startMinutes)) * 100));
        };

        // --- COMPONENTS ---

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onOpenAudioGuide }) => {
          const [, setTick] = useState(0);
          useEffect(() => { const t = setInterval(() => setTick(n => n + 1), 60000); return () => clearInterval(t); }, []);

          const calculateGap = (endStrPrev, startStrNext) => {
            const [endH, endM] = endStrPrev.split(':').map(Number);
            const [startH, startM] = startStrNext.split(':').map(Number);
            const diffMins = (startH * 60 + startM) - (endH * 60 + endM);
            return diffMins > 0 ? diffMins : 0;
          };

          return (
            <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
              <div className="flex justify-between items-end mb-6">
                <h2 className="text-2xl font-bold text-blue-900 uppercase tracking-tight">Escala Barcelona</h2>
                <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest bg-blue-50 px-2 py-1 rounded-md border border-blue-100">En Vivo</span>
              </div>
              
              <div className="relative border-l-2 border-blue-100 ml-3 space-y-8">
                {itinerary.map((act, idx) => {
                  const prevAct = idx > 0 ? itinerary[idx - 1] : null;
                  const gap = prevAct ? calculateGap(prevAct.endTime, act.startTime) : 0;
                  const isCritical = act.notes === 'CRITICAL';
                  const duration = calculateDuration(act.startTime, act.endTime);
                  const actProgress = calculateTimeProgress(act.startTime, act.endTime);
                  const gapProgress = prevAct ? calculateTimeProgress(prevAct.endTime, act.startTime) : 0;
                  
                  return (
                    <React.Fragment key={act.id}>
                      {gap > 0 && prevAct && (
                        <div className="relative ml-0 my-8">
                            <div className="absolute left-[-2px] top-[-20px] bottom-[-20px] border-l-2 border-dashed border-blue-200"></div>
                            <div className="ml-6 flex items-center">
                                <div className="bg-white/80 backdrop-blur-sm px-4 py-3 rounded-2xl border border-blue-50 flex flex-col shadow-sm w-full max-w-[240px]">
                                    <div className="flex items-center mb-2">
                                        <div className="bg-blue-100 p-1.5 rounded-full mr-3 border border-blue-200">
                                            <Clock size={12} className="text-blue-600" />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-[9px] font-black text-blue-400 uppercase tracking-widest leading-none mb-1">Traslado</span>
                                            <span className="text-[10px] font-bold text-blue-600 uppercase">{formatMinutes(gap)}</span>
                                        </div>
                                    </div>
                                    <div className="w-full h-1 bg-blue-50 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-300 transition-all duration-1000" style={{ width: `${gapProgress}%` }}></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                      )}

                      <div className="mb-8 ml-6 relative">
                        <div className={`absolute -left-[31px] top-0 rounded-full bg-white border-2 cursor-pointer transition-all z-10 ${act.completed ? 'border-emerald-500 text-emerald-500 shadow-sm' : 'border-blue-700 text-blue-700 shadow-sm'}`} onClick={() => onToggleComplete(act.id)}>
                            {act.completed ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                        </div>

                        <div className={`rounded-2xl border shadow-sm transition-all overflow-hidden bg-white ${act.completed ? 'opacity-70' : 'shadow-md'} ${isCritical ? 'border-rose-600 bg-rose-50/20' : 'border-blue-50'}`}>
                            <div className="w-full h-1.5 bg-blue-50 overflow-hidden">
                                <div className={`h-full transition-all duration-1000 ${actProgress === 100 ? 'bg-slate-300' : 'bg-blue-800'}`} style={{ width: `${actProgress}%` }}></div>
                            </div>

                            <div className="p-5">
                                <div className="flex justify-between items-start mb-2">
                                <div>
                                    <div className="flex items-center space-x-2 mb-2">
                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-800 tracking-tighter uppercase">{act.startTime} - {act.endTime}</span>
                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-600 border border-slate-200">{duration}</span>
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 leading-tight">{act.title}</h3>
                                </div>
                                {isCritical && <AlertTriangle className="text-rose-600 animate-pulse" size={20} />}
                                </div>

                                <div className="mb-3 text-sm text-slate-600 flex items-center">
                                    <MapPin size={14} className="mr-0.5 text-blue-700"/> 
                                    <span className="font-medium">{act.locationName}</span>
                                </div>

                                <p className="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line">{act.description}</p>
                                
                                <div className="bg-blue-50/50 p-3 rounded-xl text-sm text-blue-950 italic border-l-4 border-amber-500 mb-4">"{act.keyDetails}"</div>

                                {act.contingencyNote && (
                                    <div className="mt-3 mb-4 flex items-start p-3 bg-red-50 text-red-800 rounded-xl text-xs font-medium border border-red-100">
                                        <AlertCircle size={14} className="mr-2 mt-0.5 flex-shrink-0" />
                                        <span>{act.contingencyNote}</span>
                                    </div>
                                )}

                                <div className="flex flex-wrap items-center gap-2 mt-3 pt-4 border-t border-slate-50">
                                    <button onClick={() => onLocate(act.coords)} className="flex items-center text-[10px] font-bold text-blue-800 bg-blue-50 px-3 py-2 rounded-xl border border-blue-100 hover:bg-blue-100 shadow-sm transition-colors">
                                        <Navigation size={12} className="mr-1.5" /> UBICACIÓN
                                    </button>
                                    
                                    {act.googleMapsUrl && (
                                        <a href={act.googleMapsUrl} target="_blank" rel="noopener noreferrer" className="flex items-center text-[10px] font-bold text-emerald-700 bg-emerald-50 px-3 py-2 rounded-xl border border-emerald-100 hover:bg-emerald-100 shadow-sm transition-colors">
                                            <ExternalLink size={12} className="mr-1.5" /> GOOGLE MAPS
                                        </a>
                                    )}

                                    {act.audioGuideText && (
                                      <button onClick={() => onOpenAudioGuide(act)} className="flex items-center text-[10px] font-bold text-amber-700 bg-amber-50 px-3 py-2 rounded-xl border border-amber-100 shadow-sm active:bg-amber-100"><Headphones size={12} className="mr-1.5" /> AUDIOGUÍA</button>
                                    )}

                                    <div className="ml-auto">
                                        <button onClick={() => onToggleComplete(act.id)} className={`px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all ${act.completed ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'bg-blue-900 text-white shadow-md active:scale-95'}`}>
                                        {act.completed ? 'Hecho' : 'Completar'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </React.Fragment>
                  );
                })}
              </div>
            </div >
          );
        };

        const Budget = ({ itinerary }) => {
            const COLORS = ['#1e3a8a', '#be123c', '#d97706', '#64748b'];
            const paidActivities = useMemo(() => itinerary.filter(a => a.priceEUR > 0), [itinerary]);
            const total = useMemo(() => paidActivities.reduce((acc, curr) => acc + curr.priceEUR, 0), [paidActivities]);
            const chartData = useMemo(() => paidActivities.map(act => ({ name: act.title, value: act.priceEUR })), [paidActivities]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-blue-900 flex items-center uppercase tracking-tight">
                    <Wallet className="mr-2" /> Gastos
                    </h2>
                </div>

                <div className="bg-gradient-to-br from-blue-800 to-blue-950 rounded-[2rem] p-6 text-white shadow-xl mb-8 border-2 border-white/10 relative overflow-hidden">
                    <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-amber-400/20 rounded-full blur-2xl"></div>
                    <p className="text-blue-100 text-xs mb-1 uppercase tracking-widest font-black opacity-80">Presupuesto Escala</p>
                    <div className="text-4xl font-black">€{total}</div>
                    <p className="text-[10px] text-blue-100 mt-4 flex items-center font-bold uppercase tracking-tighter opacity-70">
                    <Info size={14} className="mr-1 text-amber-400"/> Incluye transporte Cruise Bus y Metro T-Familiar.
                    </p>
                </div>

                <div className="bg-white rounded-3xl shadow-sm border border-blue-50 mb-8 overflow-hidden">
                    <h3 className="px-5 py-4 border-b border-blue-50 font-black text-xs text-slate-800 uppercase tracking-widest bg-slate-50/50">Desglose Barcelona</h3>
                    {paidActivities.map((act, index) => (
                    <div key={act.id} className="flex justify-between items-center p-5 border-b border-slate-50 last:border-0">
                        <div className="flex items-center">
                        <div className="w-2.5 h-2.5 rounded-full mr-3" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                        <div>
                            <p className="text-sm font-bold text-slate-800">{act.title}</p>
                            <p className="text-[10px] text-slate-400 uppercase font-black tracking-tighter">{act.type}</p>
                        </div>
                        </div>
                        <div className="font-black text-blue-900">€{act.priceEUR}</div>
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(true);

            useEffect(() => {
                const fetchWeather = async () => {
                try {
                    const response = await fetch(
                    'https://api.open-meteo.com/v1/forecast?latitude=41.38&longitude=2.17&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FMadrid'
                    );
                    const data = await response.json();
                    setWeather({
                    hourly: { time: data.hourly.time, temperature: data.hourly.temperature_2m, code: data.hourly.weathercode },
                    daily: { time: data.daily.time, weathercode: data.daily.weathercode, temperature_2m_max: data.daily.temperature_2m_max, temperature_2m_min: data.daily.temperature_2m_min }
                    });
                } catch (error) { console.error("Clima error:", error); } finally { setLoadingWeather(false); }
                };
                fetchWeather();
            }, []);

            const playSimulatedAudio = (word) => {
                if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'ca-ES';
                utterance.rate = 0.85;
                setPlaying(word);
                utterance.onend = () => setPlaying(null);
                window.speechSynthesis.speak(utterance);
                }
            };

            const getWeatherIcon = (code, size = 20) => {
                if (code <= 1) return <Sun size={size} className="text-amber-500" />;
                if (code <= 3) return <Cloud size={size} className="text-slate-400" />;
                if (code <= 67) return <CloudRain size={size} className="text-blue-500" />;
                if (code <= 99) return <CloudLightning size={size} className="text-indigo-600" />;
                return <Wind size={size} className="text-slate-400" />;
            };

            const formatDayName = (dateStr) => {
                const date = new Date(dateStr);
                const today = new Date().toLocaleDateString();
                if (date.toLocaleDateString() === today) return "Hoy";
                return new Intl.DateTimeFormat('es-ES', { weekday: 'short' }).format(date);
            };

            return (
                <div className="pb-32 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                <h2 className="text-2xl font-bold text-blue-900 mb-6 uppercase tracking-tight">Guía Barcelona</h2>

                {/* Resumen de la Visita */}
                <div className="mb-10">
                  <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-widest px-1">
                    <ActivityIcon size={18} className="mr-2 text-blue-900"/> Resumen de la Escala
                  </h3>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white p-5 rounded-[2.5rem] border border-blue-50 shadow-sm flex flex-col items-center text-center">
                      <div className="bg-blue-100 p-2.5 rounded-2xl mb-3">
                        <Clock size={20} className="text-blue-700" />
                      </div>
                      <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Tiempo Total</span>
                      <span className="text-lg font-black text-blue-900">9h 30m</span>
                      <span className="text-[9px] text-slate-500 font-bold">08:00 - 17:30</span>
                    </div>

                    <div className="bg-white p-5 rounded-[2.5rem] border border-blue-50 shadow-sm flex flex-col items-center text-center">
                      <div className="bg-amber-100 p-2.5 rounded-2xl mb-3">
                        <Timer size={20} className="text-amber-700" />
                      </div>
                      <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Transporte</span>
                      <span className="text-lg font-black text-amber-700">~1h 50m</span>
                      <span className="text-[9px] text-slate-500 font-bold">Shuttle + Metro</span>
                    </div>

                    <div className="bg-white p-5 rounded-[2.5rem] border border-blue-50 shadow-sm flex flex-col items-center text-center">
                      <div className="bg-emerald-100 p-2.5 rounded-2xl mb-3">
                        <Landmark size={20} className="text-emerald-700" />
                      </div>
                      <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Turismo Activo</span>
                      <span className="text-lg font-black text-emerald-700">~4h 30m</span>
                      <span className="text-[9px] text-slate-500 font-bold">Tiempo en Barcelona</span>
                    </div>

                    <div className="bg-white p-5 rounded-[2.5rem] border border-blue-50 shadow-sm flex flex-col items-center text-center">
                      <div className="bg-rose-100 p-2.5 rounded-2xl mb-3">
                        <Footprints size={20} className="text-rose-700" />
                      </div>
                      <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Distancia Pie</span>
                      <span className="text-lg font-black text-rose-700">~5.4 km</span>
                      <span className="text-[9px] text-slate-500 font-bold">Total recorrido</span>
                    </div>
                  </div>

                  <div className="mt-4 bg-blue-50 p-4 rounded-3xl border border-blue-100 flex items-start gap-3">
                    <div className="bg-blue-600 p-1.5 rounded-full mt-0.5">
                      <Navigation size={12} className="text-white" />
                    </div>
                    <div>
                      <p className="text-[11px] font-bold text-blue-900 leading-tight">Nota de Interés:</p>
                      <p className="text-[10px] text-blue-700 mt-1 leading-relaxed">
                        La terminal de cruceros está a unos 10-15 mins en shuttle del Monumento a Colón. El Metro L3 (verde) es la vía más rápida para cruzar la ciudad de sur a norte.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Weather Section */}
                <div className="mb-8">
                    <div className="flex items-center justify-between mb-4 px-1">
                    <h3 className="text-sm font-black text-slate-800 flex items-center uppercase tracking-widest">
                        <Thermometer size={18} className="mr-2 text-blue-900"/> El Tiempo
                    </h3>
                    <span className="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full border border-blue-100">BCN</span>
                    </div>
                    
                    {loadingWeather ? (
                    <div className="h-32 bg-white rounded-3xl animate-pulse border border-blue-50"></div>
                    ) : (
                    <div className="space-y-4">
                        {/* Hourly */}
                        <div className="bg-white p-5 rounded-[2rem] border border-blue-50 shadow-md overflow-hidden">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Previsión por horas</p>
                        <div className="flex overflow-x-auto gap-4 no-scrollbar pb-2">
                            {weather.hourly.time.slice(0, 24).filter((_, i) => {
                            const hour = new Date(weather.hourly.time[i]).getHours();
                            return hour >= 8 && hour <= 21;
                            }).map((time, i) => (
                            <div key={time} className="flex flex-col items-center min-w-[50px]">
                                <span className="text-[10px] font-bold text-slate-500 mb-2">{new Date(time).getHours()}:00</span>
                                <div className="bg-slate-50 p-2 rounded-2xl mb-2">
                                {getWeatherIcon(weather.hourly.code[i], 20)}
                                </div>
                                <span className="text-xs font-black text-blue-900">{Math.round(weather.hourly.temperature[i])}°</span>
                            </div>
                            ))}
                        </div>
                        </div>

                        {/* 5 Day */}
                        <div className="bg-white p-5 rounded-[2rem] border border-blue-50 shadow-md">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                            <CalendarDays size={14} className="mr-1.5" /> Próximos 5 días
                        </p>
                        <div className="space-y-3">
                            {weather.daily.time.slice(0, 5).map((day, i) => (
                            <div key={day} className="flex items-center justify-between py-2 border-b border-slate-50 last:border-0">
                                <span className="text-xs font-bold text-slate-700 w-12 capitalize">{formatDayName(day)}</span>
                                <div className="flex items-center gap-3">
                                {getWeatherIcon(weather.daily.weathercode[i], 18)}
                                </div>
                                <div className="flex gap-3 text-xs font-black w-20 justify-end">
                                <span className="text-blue-900">{Math.round(weather.daily.temperature_2m_max[i])}°</span>
                                <span className="text-slate-300">{Math.round(weather.daily.temperature_2m_min[i])}°</span>
                                </div>
                            </div>
                            ))}
                        </div>
                        </div>
                    </div>
                    )}
                </div>

                <div className="mb-8 bg-rose-700 rounded-[2rem] p-6 shadow-xl text-white relative overflow-hidden border-2 border-white/10">
                    <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                    <div className="relative z-10">
                    <div className="flex items-center mb-3"><PhoneCall size={24} className="text-white animate-pulse mr-3" /><h3 className="font-black text-lg uppercase tracking-widest">ASISTENCIA SOS</h3></div>
                    <p className="text-xs text-rose-50 mb-6 leading-relaxed font-medium">Si te desorientas o pierdes el bus, contacta inmediatamente.</p>
                    <button onClick={() => window.open('https://wa.me/?text=SOS_Barcelona', '_blank')} className="w-full py-4 bg-white text-rose-800 font-black rounded-2xl flex items-center justify-center gap-2 shadow-lg uppercase tracking-widest text-sm active:scale-95 transition-transform"><Send size={18} /> Enviar Localización</button>
                    </div>
                </div>

                <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-widest px-1"><Languages size={18} className="mr-2 text-blue-900"/> Catalán Básico</h3>
                <div className="bg-white rounded-3xl shadow-md border border-blue-50 overflow-hidden mb-8">
                    {PRONUNCIATIONS.map((item) => (
                    <div key={item.word} className="p-5 flex justify-between items-center border-b border-slate-50 last:border-0 hover:bg-blue-50/30 transition-colors group">
                        <div><div className="flex items-center gap-3"><p className="font-black text-blue-950 text-lg">{item.word}</p><button onClick={() => playSimulatedAudio(item.word)} className={`p-2 rounded-full transition-all ${playing === item.word ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-400 group-hover:bg-blue-50'}`}><Volume2 size={16} /></button></div><p className="text-xs text-slate-500 italic">"{item.simplified}"</p></div>
                        <p className="text-[10px] font-black text-blue-500 bg-blue-50 px-3 py-1 rounded-full uppercase tracking-tighter border border-blue-100">{item.meaning}</p>
                    </div>
                    ))}
                </div>
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current, { zoomControl: false }).setView([41.38, 2.17], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap' }).addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                layersRef.current.forEach(layer => layer.remove());
                layersRef.current = [];

                const defaultIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                });

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng], { icon: defaultIcon }).addTo(map);
                    const navUrl = act.googleMapsUrl || `https://www.google.com/maps/dir/?api=1&destination=${act.coords.lat},${act.coords.lng}`;
                    
                    const popupContent = `
                      <div style="padding: 4px; min-width: 180px; font-family: 'Roboto Condensed', sans-serif;">
                        <h3 style="margin: 0 0 4px 0; font-weight: 800; color: #1e3a8a; font-size: 14px; text-transform: uppercase;">${act.title}</h3>
                        <p style="margin: 0 0 12px 0; font-size: 12px; color: #475569; line-height: 1.4;">${act.description}</p>
                        <a href="${navUrl}" target="_blank" style="display: block; width: 100%; text-align: center; background-color: #1e3a8a; color: white; text-decoration: none; font-weight: 700; font-size: 11px; padding: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                          INICIAR RUTA
                        </a>
                      </div>
                    `;

                    marker.bindPopup(popupContent, { maxWidth: 240 });
                    layersRef.current.push(marker);
                });

                GPX_WAYPOINTS.forEach(wpt => {
                    const circleMarker = L.circleMarker([wpt.lat, wpt.lng], {
                        radius: 6,
                        fillColor: "#BE123C",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    circleMarker.bindPopup(`<div style="font-size: 12px; font-weight: bold; color: #BE123C;">${wpt.name}</div>`);
                    layersRef.current.push(circleMarker);
                });

                const trackLine = L.polyline(BARCELONA_TRACK, { color: '#1e3a8a', weight: 4, opacity: 0.7, dashArray: '8, 12' }).addTo(map);
                layersRef.current.push(trackLine);

                if (userLocation) {
                    const userIcon = L.divIcon({ className: 'user-marker', html: '<div style="background-color: #3b82f6; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(59,130,246,0.5);"></div>', iconSize: [18, 18] });
                    const marker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map);
                    layersRef.current.push(marker);
                }
            }, [activities, userLocation]);

            useEffect(() => { if (mapInstanceRef.current && focusedLocation) mapInstanceRef.current.flyTo([focusedLocation.lat, focusedLocation.lng], 16); }, [focusedLocation]);
            return <div ref={mapContainerRef} className="w-full h-full z-0" />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [countdown, setCountdown] = useState('00h 00m 00s');
            const [audioGuideActivity, setAudioGuideActivity] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const [hours, minutes] = SHIP_ONBOARD_TIME.split(':').map(Number);
                    const target = new Date();
                    target.setHours(hours, minutes, 0, 0);
                    const diff = target.getTime() - now.getTime();
                    if (diff <= 0) setCountdown("¡A BORDO!");
                    else {
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        setCountdown(`${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`);
                    }
                }, 1000);
                setTimeout(() => { const l = document.getElementById('initial-loader'); if(l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 500); }}, 800);
                return () => clearInterval(timer);
            }, []);

            const handleLocate = (coords) => { setMapFocus(coords); setActiveTab('map'); };

            const handlePlayAudio = () => {
              if (!audioGuideActivity?.audioGuideText) return;
              if (isPlaying) {
                window.speechSynthesis.cancel();
                setIsPlaying(false);
              } else {
                const utterance = new SpeechSynthesisUtterance(audioGuideActivity.audioGuideText);
                utterance.lang = 'es-ES';
                utterance.rate = 0.95;
                utterance.onend = () => setIsPlaying(false);
                window.speechSynthesis.speak(utterance);
                setIsPlaying(true);
              }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden">
                <header className="bg-blue-950 text-white p-4 shadow-xl z-20 flex justify-between items-center shrink-0">
                    <div className="flex items-center">
                    <Anchor className="mr-3 text-amber-500" size={24} />
                    <div><h1 className="font-black text-[10px] uppercase tracking-[0.2em] text-blue-300">Escala Barcelona</h1><p className="text-[12px] font-bold text-white/90 leading-tight">12 Abril 2026</p></div>
                    </div>
                    <div className="flex flex-col items-end"><span className="text-[8px] font-black uppercase text-amber-400 tracking-widest mb-0.5">Límite Embarque</span><div className="text-lg font-black font-mono text-white leading-none tracking-tighter">{countdown}</div></div>
                </header>

                <main className="flex-1 overflow-hidden relative">
                    {activeTab === 'timeline' && (
                      <div className="h-full overflow-y-auto no-scrollbar">
                        <Timeline 
                          itinerary={itinerary} 
                          onToggleComplete={(id) => setItinerary(itinerary.map(a => a.id === id ? {...a, completed: !a.completed} : a))} 
                          onLocate={handleLocate} 
                          userLocation={userLocation} 
                          onOpenAudioGuide={(act) => setAudioGuideActivity(act)}
                        />
                      </div>
                    )}
                    {activeTab === 'map' && (<MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />)}
                    {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                    {activeTab === 'guide' && <Guide userLocation={userLocation} />}

                    {audioGuideActivity && (
                      <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-blue-950/40 backdrop-blur-sm">
                        <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden p-8">
                          <div className="flex justify-between items-start mb-6">
                            <div className="bg-blue-100 p-3 rounded-2xl border border-blue-200">
                              <Headphones size={24} className="text-blue-700" />
                            </div>
                            <button onClick={() => { window.speechSynthesis.cancel(); setIsPlaying(false); setAudioGuideActivity(null); }} className="text-slate-300 hover:text-slate-600 transition-colors">
                              <X size={28} />
                            </button>
                          </div>
                          <h3 className="text-xs font-black text-blue-400 uppercase tracking-[0.2em] mb-2">Audioguía</h3>
                          <h4 className="text-xl font-black text-slate-800 mb-6 leading-tight">{audioGuideActivity.title}</h4>
                          <div className="max-h-[300px] overflow-y-auto pr-2 custom-h-scrollbar mb-8">
                            <p className="text-slate-600 leading-relaxed font-medium italic">{audioGuideActivity.audioGuideText}</p>
                          </div>
                          <button onClick={handlePlayAudio} className={`w-full flex items-center justify-center gap-3 py-4 rounded-3xl font-black uppercase tracking-widest text-sm transition-all shadow-lg ${isPlaying ? 'bg-rose-600 text-white' : 'bg-blue-900 text-white'}`}>
                            {isPlaying ? <Square size={18} fill="white" /> : <Play size={18} fill="white" />}
                            {isPlaying ? 'Detener' : 'Escuchar'}
                          </button>
                        </div>
                      </div>
                    )}
                </main>

                <nav className="bg-white/95 backdrop-blur-md border-t border-slate-100 z-30 shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                    <div className="flex justify-around items-center h-20 px-2 pb-safe">
                    {[{ id: 'timeline', icon: CalendarClock, label: 'Itinerario' }, { id: 'map', icon: MapIcon, label: 'Mapa' }, { id: 'budget', icon: Wallet, label: 'Gastos' }, { id: 'guide', icon: BookOpen, label: 'Guía' }].map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full justify-center transition-all ${activeTab === tab.id ? 'text-blue-900' : 'text-slate-400'}`}>
                        <div className={`p-2 rounded-xl mb-1 ${activeTab === tab.id ? 'bg-blue-50 shadow-sm' : ''}`}><tab.icon size={22} /></div><span className="text-[9px] font-black uppercase tracking-widest">{tab.label}</span>
                        </button>
                    ))}
                    </div>
                </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>